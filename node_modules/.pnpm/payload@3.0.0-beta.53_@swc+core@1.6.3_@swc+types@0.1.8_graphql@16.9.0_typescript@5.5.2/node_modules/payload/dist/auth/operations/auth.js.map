{"version":3,"sources":["../../../src/auth/operations/auth.ts"],"sourcesContent":["import type { GeneratedTypes } from '../../index.js'\nimport type { PayloadRequestWithData } from '../../types/index.js'\nimport type { Permissions, User } from '../types.js'\n\nimport { commitTransaction } from '../../utilities/commitTransaction.js'\nimport { initTransaction } from '../../utilities/initTransaction.js'\nimport { killTransaction } from '../../utilities/killTransaction.js'\nimport { parseCookies } from '../cookies.js'\nimport { executeAuthStrategies } from '../executeAuthStrategies.js'\nimport { getAccessResults } from '../getAccessResults.js'\n\nexport type AuthArgs = {\n  headers: Request['headers']\n  req?: Omit<PayloadRequestWithData, 'user'>\n}\n\nexport type AuthResult = {\n  cookies: Map<string, string>\n  permissions: Permissions\n  user: GeneratedTypes['user'] | null\n}\n\nexport const auth = async (args: Required<AuthArgs>): Promise<AuthResult> => {\n  const { headers } = args\n  const req = args.req as PayloadRequestWithData\n  const { payload } = req\n\n  const cookies = parseCookies(headers)\n\n  try {\n    const shouldCommit = await initTransaction(req)\n\n    const user = await executeAuthStrategies({\n      cookies,\n      headers,\n      payload,\n    })\n\n    req.user = user\n\n    const permissions = await getAccessResults({\n      req,\n    })\n\n    if (shouldCommit) await commitTransaction(req)\n\n    return {\n      cookies,\n      permissions,\n      user,\n    }\n  } catch (error: unknown) {\n    await killTransaction(req)\n    throw error\n  }\n}\n"],"names":["commitTransaction","initTransaction","killTransaction","parseCookies","executeAuthStrategies","getAccessResults","auth","args","headers","req","payload","cookies","shouldCommit","user","permissions","error"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"AAIA,SAASA,iBAAiB,QAAQ,uCAAsC;AACxE,SAASC,eAAe,QAAQ,qCAAoC;AACpE,SAASC,eAAe,QAAQ,qCAAoC;AACpE,SAASC,YAAY,QAAQ,gBAAe;AAC5C,SAASC,qBAAqB,QAAQ,8BAA6B;AACnE,SAASC,gBAAgB,QAAQ,yBAAwB;AAazD,OAAO,MAAMC,OAAO,OAAOC;IACzB,MAAM,EAAEC,OAAO,EAAE,GAAGD;IACpB,MAAME,MAAMF,KAAKE,GAAG;IACpB,MAAM,EAAEC,OAAO,EAAE,GAAGD;IAEpB,MAAME,UAAUR,aAAaK;IAE7B,IAAI;QACF,MAAMI,eAAe,MAAMX,gBAAgBQ;QAE3C,MAAMI,OAAO,MAAMT,sBAAsB;YACvCO;YACAH;YACAE;QACF;QAEAD,IAAII,IAAI,GAAGA;QAEX,MAAMC,cAAc,MAAMT,iBAAiB;YACzCI;QACF;QAEA,IAAIG,cAAc,MAAMZ,kBAAkBS;QAE1C,OAAO;YACLE;YACAG;YACAD;QACF;IACF,EAAE,OAAOE,OAAgB;QACvB,MAAMb,gBAAgBO;QACtB,MAAMM;IACR;AACF,EAAC"}